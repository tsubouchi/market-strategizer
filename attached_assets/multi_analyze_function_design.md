3C分析・4P分析・PEST分析の結果を統合し、最終的に商品コンセプトを多段推論で導き出すAI駆動型システムの要件を示します。
すでに存在する3C・4P・PEST分析の機能要件に加え、本システムでは 「分析結果の統合と多段推論による商品コンセプト創出」 を新たに実装します。

要件書

1. プロジェクト概要
	•	システム名称
AI多段推論型 統合分析＆商品コンセプト創出システム (仮)
	•	背景・目的
	1.	従来の3C分析、4P分析、PEST分析結果が個別のレポートとして出ていたが、相互に関連性をもたせて商品・サービスのコンセプトを創出する仕組みが求められている。
	2.	AIを活用し、段階的（多段階）に思考プロセスを進めながら統合分析を行い、ユーザーが最終的にアイデアを具現化できるようにする。
	•	開発・学習の狙い
	•	OpenAIなどのLLMによる多段推論（Chain of Thought）手法の実践。
	•	すでに実装済みの3C/4P/PEST分析との連携をシームレスに行う。
	•	統合された分析結果をもとに、商品コンセプトの仮説を生成・提案し、ユーザーが修正・確定できるUIを提供する。

3. システム要件

3.1. 機能要件
	1.	分析結果データ取得機能
	•	既存の3C・4P・PEST分析テーブル（例：analysesテーブル）の内容を参照し、必要な情報をまとめて取得できる。
	•	例: analysis_type = '3C', '4P', 'PEST' の各レコードを一括で取り出し、AIが扱いやすい形式(JSON等)に変換。
	2.	多段推論（Chain of Thought）エンジン
	•	OpenAIなどのLLM APIをコールする際、以下のステップを踏んで推論を行う。
	1.	統合準備ステップ: 3C/4P/PESTから抽出した要点をLLMがまず要約し、カテゴリ分けする。
	2.	関連性分析ステップ: 各分析フレームワークの項目（例: 3CのCompetitorで得た情報と4PのPromotion戦略の関連性）を深掘り・相互参照し、潜在的な課題や機会を抽出する。
	3.	コンセプト候補生成ステップ: 上記の分析をベースに、商品コンセプト候補を複数案生成する。
	4.	最終絞り込みステップ: 生成された複数案を比較し、ユーザーが望む条件（ターゲット顧客、開発期間、予算など）を踏まえた最終候補を提案する。
	3.	ユーザーインタラクションと編集機能
	•	多段推論の各ステップで得られた結果を画面表示し、ユーザーが修正や追記を行えるUIを用意する。
	•	たとえば、2ステップ目で得られた「潜在的な課題リスト」にユーザーが手動でコメントを入れ、LLMに再学習リクエストを送ることが可能。
	4.	商品コンセプト編集・確定機能
	•	ユーザーがLLMの提案した商品コンセプト案を受け取り、
	•	タイトル、
	•	ターゲット層、
	•	提供価値（Value Proposition）、
	•	競合優位性 などの要素を追記・修正し、最終的なコンセプトを確定できる。
	•	コンセプト確定時にデータベースへ保存し、再度呼び出し・編集が可能。
	5.	レポート出力機能
	•	統合分析のプロセス（要点のまとめ、課題抽出、コンセプト候補、最終決定コンセプト）を時系列でドキュメント化し、PDFまたはWebページとして出力。
	•	既存の分析結果レポートともリンクを張り、一つの総合レポートとして利用可能にする。
	6.	権限管理・認証
	•	既存のユーザー管理（Supabase Auth 等）に基づき、ログイン済みユーザーのみが多段推論機能にアクセスできる。
	•	自身の分析結果だけを統合に利用できる。またはチーム内で共有された分析結果だけを利用可能にする。
	7.	APIエラー・例外ハンドリング
	•	OpenAI APIへの呼び出しがタイムアウト・エラーとなる場合に、適切にリトライやエラーメッセージ表示を行う。
	•	ユーザー入力が不十分な場合は、必要事項を再入力させるフローを提供。

3.2. 非機能要件
	1.	パフォーマンス
	•	多段推論はステップごとにAPI呼び出しを行うため、ステップ間の待ち時間が長くなりすぎないように工夫する。
	•	同時に10ユーザー程度が多段推論を走らせても問題ない設計。
	2.	拡張性
	•	将来的に他の分析フレームワーク（SWOT分析など）を追加しやすい構造にする。
	•	多段推論のステップをカスタマイズ可能にする（新たなステップの挿入・削除）。
	3.	セキュリティ
	•	LLM APIキーの秘匿管理（環境変数やSupabaseの秘密管理機能を使用）
	•	HTTPS通信の徹底
	4.	操作性
	•	多段推論プロセスを可視化（どの段階でどんな回答が得られたか）
	•	ステップが進むごとに画面を分割・更新し、ユーザーがどこまで進んでいるかを把握できるUIデザイン
	5.	可用性
	•	分析内容や推論中間結果は随時自動保存し、ブラウザを閉じても再開できる。

4. システム構成（拡張部分）

既存の3C/4P/PEST分析システムをベースに、以下を追加・拡張します。
	1.	多段推論フロー制御モジュール
	•	例えばバックエンド（Node.js/Express など）で実装するか、フロントエンド(Next.js) でサーバーレスAPIとして実装する方法を選択。
	•	各ステップ（要約、関連性分析、コンセプト生成、絞り込み）に対応するAPIエンドポイントまたは関数を設ける。
	2.	AIアシスト・シークエンス管理
	•	LangChainや独自のステート管理を用い、ステップごとのプロンプト設計を管理。
	•	ステップ1→ステップ2→ステップ3… の順にLLMへ入力する際、前のステップの結果をプロンプトへ埋め込み。
	3.	統合コンセプト保存テーブル
	•	例: concepts テーブルをSupabase上に新設。		

CREATE TABLE IF NOT EXISTS concepts (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES users (id) ON DELETE CASCADE,
  title varchar NOT NULL,               -- 商品コンセプトのタイトル
  value_proposition text,               -- 提供価値
  target_customer text,                 -- ターゲット顧客
  advantage text,                       -- 競合優位性・他社との差別化
  raw_data jsonb,                       -- 多段推論の中間結果など
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now()
);	

•	raw_data に、多段推論の中間プロセスやAIの提案内容、ユーザーの編集ログなどを保存しておく。

	4.	レポート生成
	•	既存の分析レポートに加えて、多段推論の結果をまとめる総合レポートをHTMLで生成し、PDFに変換。
	•	フロントエンド側でReactのコンポーネントを用いてレポートプレビュー画面を提供。

5. 画面一覧（拡張分）
	1.	統合分析スタート画面
	•	ユーザーが「3C・4P・PESTの統合分析を開始」ボタンを押すと、多段推論の第一ステップ（要約）を開始。
	2.	多段推論ステップ画面
	•	ステップ1: 既存分析の要点要約
	•	要約された内容を表示。必要に応じてユーザーがコメントを追加し再度要約し直すことも可能。
	•	ステップ2: 関連性分析
	•	3Cと4P、PESTの重複・矛盾・相互補完などをLLMが提示。ユーザーはコメントや編集を入れられる。
	•	ステップ3: コンセプト候補の生成
	•	複数のコンセプト案が表示される。ユーザーは絞り込みの基準や要望を追加入力できる。
	•	ステップ4: 最終コンセプト絞り込み
	•	絞り込まれたコンセプト案をユーザーが最終決定し、データベースへ保存。
	3.	コンセプト編集・確認画面
	•	保存されたコンセプトを再度開き、テキスト編集・AIへの再問い合わせが可能。
	4.	総合レポートプレビュー画面
	•	多段推論の履歴および最終コンセプトをまとめたレイアウト表示。

6. ユーザーストーリー（新規分）
	1.	既存分析をもとにコンセプトを作りたいユーザー
	•	「統合分析開始」ボタンを押し、LLMのステップバイステップな推論結果を見ながら、最終的な商品コンセプトを確定したい。
	2.	複数のコンセプト案を比較・検討したいユーザー
	•	ステップ3で表示された複数案を一覧で確認し、「自社のリソース」「開発期間」などをLLMに伝えて再提案させる。
	3.	コンセプトの妥当性を上司やクライアントに説明したいユーザー
	•	総合レポートをPDF出力し、3C・4P・PESTの分析プロセスから得られた裏付けを提示する。	
	•	PDF出力用ボタン。	